# 充电分析系统设计文档

## 1. 数据库设计

### 1.1 PostgreSQL数据库设计

#### 1.1.1 用户表 (users)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user', -- 'user' or 'admin'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
```

#### 1.1.2 分析任务表 (analysis_tasks)
```sql
CREATE TABLE analysis_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT,
    status VARCHAR(20) NOT NULL, -- 'pending', 'processing', 'completed', 'failed'
    progress INTEGER DEFAULT 0,
    result_path VARCHAR(500),
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE INDEX idx_analysis_tasks_user_id ON analysis_tasks(user_id);
CREATE INDEX idx_analysis_tasks_status ON analysis_tasks(status);
CREATE INDEX idx_analysis_tasks_created_at ON analysis_tasks(created_at);
```

#### 1.1.3 数据集表 (datasets)
```sql
CREATE TABLE datasets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    type VARCHAR(20) NOT NULL, -- 'normal' or 'chain_of_thought'
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT,
    record_count INTEGER,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

CREATE INDEX idx_datasets_type ON datasets(type);
CREATE INDEX idx_datasets_created_by ON datasets(created_by);
```

#### 1.1.4 训练任务表 (training_tasks)
```sql
CREATE TABLE training_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    dataset_id UUID REFERENCES datasets(id),
    model_type VARCHAR(50) NOT NULL,
    hyperparameters JSONB,
    status VARCHAR(20) NOT NULL, -- 'pending', 'running', 'completed', 'failed', 'cancelled'
    progress INTEGER DEFAULT 0,
    current_epoch INTEGER DEFAULT 0,
    total_epochs INTEGER NOT NULL,
    loss_history JSONB, -- [{epoch: 1, loss: 0.5, val_loss: 0.6}, ...]
    metrics JSONB, -- {accuracy: 0.95, f1_score: 0.93, ...}
    model_path VARCHAR(500),
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE INDEX idx_training_tasks_status ON training_tasks(status);
CREATE INDEX idx_training_tasks_created_by ON training_tasks(created_by);
CREATE INDEX idx_training_tasks_dataset_id ON training_tasks(dataset_id);
```

#### 1.1.5 模型版本表 (model_versions)
```sql
CREATE TABLE model_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    training_task_id UUID REFERENCES training_tasks(id),
    version VARCHAR(50) NOT NULL, -- 'v1.0.0', 'v1.1.0', etc.
    model_path VARCHAR(500) NOT NULL,
    metrics JSONB,
    is_active BOOLEAN DEFAULT FALSE,
    is_production BOOLEAN DEFAULT FALSE,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    activated_at TIMESTAMP
);

CREATE INDEX idx_model_versions_version ON model_versions(version);
CREATE INDEX idx_model_versions_is_active ON model_versions(is_active);
CREATE INDEX idx_model_versions_is_production ON model_versions(is_production);
```

#### 1.1.6 RAG知识库表 (rag_knowledge)
```sql
CREATE TABLE rag_knowledge (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(50), -- '故障案例', '技术手册', '操作指南'等
    tags TEXT[], -- 标签数组
    file_path VARCHAR(500), -- 原始文件路径
    embedding_id VARCHAR(255), -- ChromaDB中的ID
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

CREATE INDEX idx_rag_knowledge_category ON rag_knowledge(category);
CREATE INDEX idx_rag_knowledge_tags ON rag_knowledge USING GIN(tags);
```

#### 1.1.7 日志表 (logs)
```sql
CREATE TABLE logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    timestamp TIMESTAMP NOT NULL,
    level VARCHAR(10) NOT NULL, -- 'DEBUG', 'INFO', 'WARNING', 'ERROR'
    service VARCHAR(50) NOT NULL,
    user_id UUID REFERENCES users(id),
    task_id UUID,
    message TEXT NOT NULL,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_logs_timestamp ON logs(timestamp);
CREATE INDEX idx_logs_level ON logs(level);
CREATE INDEX idx_logs_service ON logs(service);
CREATE INDEX idx_logs_user_id ON logs(user_id);
CREATE INDEX idx_logs_task_id ON logs(task_id);
-- 使用TimescaleDB扩展（如果可用）
-- SELECT create_hypertable('logs', 'timestamp');
```

### 1.2 ChromaDB向量数据库

#### 1.2.1 集合设计
- **集合名称**: `charging_knowledge`
- **嵌入维度**: 768 (BGE-base-zh-v1.5)
- **元数据字段**:
  - `title`: 文档标题
  - `category`: 文档类别
  - `tags`: 标签列表
  - `source`: 来源
  - `created_at`: 创建时间

### 1.3 Redis缓存设计

#### 1.3.1 缓存键设计
- `user:session:{user_id}`: 用户会话信息
- `task:progress:{task_id}`: 任务进度
- `model:cache:{model_version}`: 模型缓存
- `rag:cache:{query_hash}`: RAG查询缓存

## 2. API设计

### 2.1 认证API

#### 2.1.1 用户注册
```
POST /api/v1/auth/register
Request Body:
{
    "username": "string",
    "email": "string",
    "password": "string"
}
Response:
{
    "user_id": "uuid",
    "username": "string",
    "token": "jwt_token"
}
```

#### 2.1.2 用户登录
```
POST /api/v1/auth/login
Request Body:
{
    "username": "string",
    "password": "string"
}
Response:
{
    "user_id": "uuid",
    "username": "string",
    "role": "user|admin",
    "token": "jwt_token",
    "expires_in": 3600
}
```

#### 2.1.3 Token刷新
```
POST /api/v1/auth/refresh
Headers:
    Authorization: Bearer {refresh_token}
Response:
{
    "token": "new_jwt_token",
    "expires_in": 3600
}
```

### 2.2 充电分析API

#### 2.2.1 文件上传
```
POST /api/v1/analysis/upload
Headers:
    Authorization: Bearer {token}
    Content-Type: multipart/form-data
Request Body:
    file: binary (BLF file)
Response:
{
    "task_id": "uuid",
    "file_name": "string",
    "file_size": 12345,
    "status": "pending"
}
```

#### 2.2.2 开始分析
```
POST /api/v1/analysis/start
Headers:
    Authorization: Bearer {token}
Request Body:
{
    "task_id": "uuid"
}
Response:
{
    "task_id": "uuid",
    "status": "processing"
}
```

#### 2.2.3 查询分析进度
```
GET /api/v1/analysis/{task_id}/progress
Headers:
    Authorization: Bearer {token}
Response:
{
    "task_id": "uuid",
    "status": "processing",
    "progress": 50,
    "current_step": "rag_retrieval"
}
```

#### 2.2.4 获取分析结果（流式）
```
GET /api/v1/analysis/{task_id}/result/stream
Headers:
    Authorization: Bearer {token}
Response: Server-Sent Events (SSE)
data: {"type": "thinking", "content": "正在分析..."}
data: {"type": "response", "content": "分析结果..."}
```

#### 2.2.5 获取分析报告
```
GET /api/v1/analysis/{task_id}/report
Headers:
    Authorization: Bearer {token}
Response:
{
    "task_id": "uuid",
    "report_path": "string",
    "report_url": "string",
    "summary": {
        "problem_type": "string",
        "key_signals": ["signal1", "signal2"],
        "diagnosis": "string",
        "recommendations": ["rec1", "rec2"]
    }
}
```

### 2.3 训练管理API

#### 2.3.1 数据集管理
```
# 上传数据集
POST /api/v1/training/datasets
Headers:
    Authorization: Bearer {token} (admin only)
Request Body:
    file: binary
    name: string
    description: string
    type: "normal" | "chain_of_thought"

# 获取数据集列表
GET /api/v1/training/datasets
Headers:
    Authorization: Bearer {token} (admin only)

# 删除数据集
DELETE /api/v1/training/datasets/{dataset_id}
Headers:
    Authorization: Bearer {token} (admin only)
```

#### 2.3.2 训练任务管理
```
# 创建训练任务
POST /api/v1/training/tasks
Headers:
    Authorization: Bearer {token} (admin only)
Request Body:
{
    "name": "string",
    "dataset_id": "uuid",
    "model_type": "string",
    "hyperparameters": {
        "learning_rate": 0.001,
        "batch_size": 32,
        "epochs": 100
    }
}

# 获取训练任务列表
GET /api/v1/training/tasks
Headers:
    Authorization: Bearer {token} (admin only)

# 获取训练任务详情
GET /api/v1/training/tasks/{task_id}
Headers:
    Authorization: Bearer {token} (admin only)

# 获取训练进度（实时）
GET /api/v1/training/tasks/{task_id}/progress
Headers:
    Authorization: Bearer {token} (admin only)
Response:
{
    "task_id": "uuid",
    "status": "running",
    "progress": 50,
    "current_epoch": 25,
    "total_epochs": 50,
    "loss": 0.5,
    "val_loss": 0.6,
    "metrics": {
        "accuracy": 0.95
    }
}

# 获取Loss曲线数据
GET /api/v1/training/tasks/{task_id}/loss-curve
Headers:
    Authorization: Bearer {token} (admin only)
Response:
{
    "train_loss": [0.8, 0.6, 0.5, ...],
    "val_loss": [0.9, 0.7, 0.6, ...],
    "epochs": [1, 2, 3, ...]
}
```

#### 2.3.3 模型版本管理
```
# 获取模型版本列表
GET /api/v1/training/models
Headers:
    Authorization: Bearer {token} (admin only)

# 激活模型版本
POST /api/v1/training/models/{version_id}/activate
Headers:
    Authorization: Bearer {token} (admin only)

# 回滚模型版本
POST /api/v1/training/models/{version_id}/rollback
Headers:
    Authorization: Bearer {token} (admin only)

# 评估模型
POST /api/v1/training/models/{version_id}/evaluate
Headers:
    Authorization: Bearer {token} (admin only)
Request Body:
{
    "test_dataset_id": "uuid"
}
```

### 2.4 RAG管理API

#### 2.4.1 知识库管理
```
# 上传知识文档
POST /api/v1/rag/knowledge
Headers:
    Authorization: Bearer {token} (admin only)
Request Body:
    file: binary (PDF/TXT/MD)
    title: string
    category: string
    tags: string[]

# 获取知识库列表
GET /api/v1/rag/knowledge
Headers:
    Authorization: Bearer {token} (admin only)

# 删除知识文档
DELETE /api/v1/rag/knowledge/{knowledge_id}
Headers:
    Authorization: Bearer {token} (admin only)

# 搜索知识库
POST /api/v1/rag/knowledge/search
Headers:
    Authorization: Bearer {token} (admin only)
Request Body:
{
    "query": "string",
    "top_k": 5
}
```

### 2.5 日志管理API

#### 2.5.1 查询日志
```
GET /api/v1/logs
Headers:
    Authorization: Bearer {token} (admin only)
Query Parameters:
    start_time: ISO datetime
    end_time: ISO datetime
    level: DEBUG|INFO|WARNING|ERROR
    service: string
    user_id: uuid
    task_id: uuid
    keyword: string
    page: int
    page_size: int
Response:
{
    "total": 100,
    "page": 1,
    "page_size": 20,
    "logs": [...]
}
```

#### 2.5.2 日志统计
```
GET /api/v1/logs/statistics
Headers:
    Authorization: Bearer {token} (admin only)
Query Parameters:
    start_time: ISO datetime
    end_time: ISO datetime
Response:
{
    "total_count": 1000,
    "by_level": {
        "DEBUG": 200,
        "INFO": 600,
        "WARNING": 150,
        "ERROR": 50
    },
    "by_service": {
        "charging_agent": 500,
        "training_service": 300,
        ...
    }
}
```

## 3. 安全设计

### 3.1 认证机制

#### 3.1.1 JWT Token
- **算法**: HS256
- **有效期**: Access Token 1小时，Refresh Token 7天
- **存储**: Redis（用于黑名单管理）
- **刷新机制**: 自动刷新，提前5分钟

#### 3.1.2 密码安全
- **加密**: bcrypt，salt rounds = 12
- **强度要求**: 至少8位，包含字母和数字
- **重置机制**: 邮箱验证码

### 3.2 权限控制

#### 3.2.1 角色定义
- **普通用户 (user)**:
  - 首页、对话、充电分析
  
- **管理员 (admin)**:
  - 所有普通用户权限
  - 训练管理、RAG管理、日志管理

#### 3.2.2 权限检查
- **装饰器模式**: `@require_role('admin')`
- **中间件**: 统一权限验证
- **API级别**: 每个端点进行权限检查

### 3.3 数据安全

#### 3.3.1 文件上传安全
- **文件类型验证**: 白名单（.blf, .pdf, .txt, .md等）
- **文件大小限制**: 最大100MB
- **病毒扫描**: ClamAV（可选）
- **存储隔离**: 用户文件隔离存储

#### 3.3.2 数据加密
- **敏感数据**: 数据库加密存储
- **传输加密**: HTTPS强制
- **API密钥**: 环境变量管理

### 3.4 API限流

#### 3.4.1 限流策略
- **全局限流**: 1000请求/分钟
- **用户限流**: 100请求/分钟
- **文件上传**: 10次/小时
- **实现**: Redis + 令牌桶算法

## 4. 性能设计

### 4.1 缓存策略

#### 4.1.1 Redis缓存
- **用户会话**: 1小时TTL
- **模型缓存**: 24小时TTL
- **RAG查询结果**: 1小时TTL
- **任务进度**: 实时更新

#### 4.1.2 数据库查询优化
- **索引**: 关键字段建立索引
- **连接池**: SQLAlchemy连接池
- **查询优化**: 避免N+1查询

### 4.2 异步处理

#### 4.2.1 任务队列
- **框架**: Celery + Redis
- **任务类型**: 
  - 分析任务（长时间运行）
  - 训练任务（长时间运行）
  - 文件处理（中等时间）

#### 4.2.2 流式响应
- **SSE**: 分析结果流式返回
- **WebSocket**: 实时进度更新（可选）

### 4.3 负载均衡

#### 4.3.1 水平扩展
- **无状态服务**: API服务无状态
- **负载均衡**: Nginx / HAProxy
- **服务发现**: Consul（可选）

## 5. 错误处理

### 5.1 错误分类
- **4xx**: 客户端错误（参数错误、权限不足等）
- **5xx**: 服务器错误（内部错误、服务不可用等）

### 5.2 错误响应格式
```json
{
    "error": {
        "code": "ERROR_CODE",
        "message": "错误描述",
        "details": {}
    }
}
```

### 5.3 错误码定义
- `AUTH_REQUIRED`: 需要认证
- `PERMISSION_DENIED`: 权限不足
- `INVALID_PARAMETER`: 参数错误
- `FILE_TOO_LARGE`: 文件过大
- `TASK_NOT_FOUND`: 任务不存在
- `INTERNAL_ERROR`: 内部错误

