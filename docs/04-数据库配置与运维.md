### PostgreSQL 数据库配置与运维指南

本文档说明如何将后端连接到远程 PostgreSQL（59.110.13.212），并初始化数据表与日常运维建议。

#### 1. 连接信息
- 主机：59.110.13.212（示例）
- 端口：5432
- 用户：appuser
- 数据库：appdb
- 密码：Str0ngP@ss_ChangeMe（URL 中需将 @ 编码为 %40）

#### 2. 应用配置
后端读取 `app/config.py` 或 `.env` 中的 `DATABASE_URL`。我们已在代码中设置默认值：

```
postgresql+asyncpg://appuser:Str0ngP%40ss_ChangeMe@59.110.13.212:5432/appdb
```

建议在生产或多人协作时使用 `.env` 覆盖：

```
DATABASE_URL=postgresql+asyncpg://appuser:Str0ngP%40ss_ChangeMe@59.110.13.212:5432/appdb
```

#### 3. 首次初始化（自动建表）
应用启动时会自动执行建表逻辑：
- 文件：`app/main.py`
- 逻辑：在 `startup` 事件中 `Base.metadata.create_all`（异步方式）

无需手动执行 SQL 脚本即可创建以下表：
- `users`（用户表，UUID 主键，唯一用户名/邮箱等）
- `analysis_tasks`（分析任务表，关联 `users.id`）

#### 4. 手动验证连接（可选）
本地安装 `psql` 后执行：

```bash
psql "host=59.110.13.212 port=5432 dbname=appdb user=appuser password=Str0ngP@ss_ChangeMe"
```

查看数据表：
```sql
\dt
```

#### 5. 常见问题排查
- 连接失败：检查安全组/防火墙是否放通 5432；确认用户名/密码/数据库名称。
- 密码含特殊字符：在 `DATABASE_URL` 中进行 URL 编码（如 `@` -> `%40`）。
- 500 错误：查看应用日志；若为数据库相关，多为连接失败或权限不足。

#### 6. 性能与安全建议
- 生产建议关闭 `DEBUG`，并限制 CORS 域名。
- 使用只读/只写分离账号；定期轮换密码。
- 备份策略：使用 `pg_dump` 定期备份（全量/增量），并验证恢复流程。
- 连接池参数：根据负载调整 `pool_size`、`max_overflow`。

#### 7. 维护命令速查
- 备份：
```bash
pg_dump -h 59.110.13.212 -p 5432 -U appuser -d appdb -F c -f appdb_$(date +%F).dump
```
- 恢复：
```bash
pg_restore -h 59.110.13.212 -p 5432 -U appuser -d appdb -c appdb_YYYY-MM-DD.dump
```

—— 完 ——


