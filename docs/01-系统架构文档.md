# 充电分析系统架构文档

## 1. 系统概述

本系统是一个基于React Native前端和LangGraph Python后端的智能充电分析平台，提供充电数据分析、RAG知识管理、模型训练和日志管理等功能。

## 2. 整体架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      React Native 前端                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │  首页    │ │  对话    │ │ 充电分析 │ │ RAG管理  │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│  ┌──────────┐ ┌──────────┐                                 │
│  │ 训练管理 │ │ 日志管理 │                                 │
│  └──────────┘ └──────────┘                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                    HTTPS/REST API
                            │
┌─────────────────────────────────────────────────────────────┐
│                    Python 后端服务层                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          FastAPI REST API Gateway                    │   │
│  │  - 用户认证与授权                                     │   │
│  │  - 请求路由与负载均衡                                 │   │
│  └──────────────────────────────────────────────────────┘   │
│                            │                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          LangGraph Agent 编排层                       │   │
│  │  - 充电分析Agent (主Agent)                            │   │
│  │  - 热管理Agent (预留)                                 │   │
│  │  - 能量Agent (预留)                                   │   │
│  │  - 行驶Agent (预留)                                   │   │
│  │  - Agent协同调度器                                    │   │
│  └──────────────────────────────────────────────────────┘   │
│                            │                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          核心服务层                                   │   │
│  │  - 报文处理服务                                       │   │
│  │  - RAG检索服务 (ChromaDB + BGE)                       │   │
│  │  - 流程控制模型服务 (1.5B)                            │   │
│  │  - LLM调用服务 (OpenAI格式)                           │   │
│  │  - 报告生成服务                                       │   │
│  └──────────────────────────────────────────────────────┘   │
│                            │                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          数据存储层                                   │   │
│  │  - PostgreSQL (用户、训练任务、日志元数据)             │   │
│  │  - ChromaDB (向量数据库)                              │   │
│  │  - MinIO/S3 (文件存储：BLF文件、训练数据)              │   │
│  │  - Redis (缓存、会话)                                  │   │
│  └──────────────────────────────────────────────────────┘   │
│                            │                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          训练服务层                                   │   │
│  │  - 数据集管理                                         │   │
│  │  - 训练任务调度                                       │   │
│  │  - 模型版本管理                                       │   │
│  │  - 评估服务                                           │   │
│  └──────────────────────────────────────────────────────┘   │
│                            │                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          日志服务层                                   │   │
│  │  - 结构化日志收集                                     │   │
│  │  - 日志查询与分析                                     │   │
│  │  - 日志存储 (PostgreSQL + 时序数据库)                  │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

#### 前端
- **框架**: React Native
- **状态管理**: Redux Toolkit / Zustand
- **导航**: React Navigation
- **HTTP客户端**: Axios
- **UI组件库**: React Native Paper / NativeBase
- **图表**: react-native-chart-kit / Victory Native

#### 后端
- **Web框架**: FastAPI
- **Agent框架**: LangGraph
- **向量数据库**: ChromaDB
- **嵌入模型**: BGE-base-zh-v1.5
- **流程控制模型**: 1.5B本地模型 (支持训练)
- **LLM调用**: OpenAI兼容API (支持多种后端)
- **关系数据库**: PostgreSQL
- **缓存**: Redis
- **对象存储**: MinIO / S3
- **日志框架**: structlog + ELK / Loki
- **任务队列**: Celery + Redis

## 3. 核心模块架构

### 3.1 充电分析Agent流程

```
报文上传
    │
    ▼
报文处理工具 (CanParse)
    │
    ▼
DataFrame数据
    │
    ▼
1.5B流程控制模型
    │
    ▼
确定3个关键信号 → 问题大方向
    │
    ▼
RAG系统检索
    │
    ├─→ 获取相关最新知识
    └─→ 获取3个细化问题关键信号
    │
    ▼
1.5B流程控制模型 (最多3次迭代)
    │
    ├─→ 分析实际信号表现
    ├─→ 推断问题类型
    └─→ 明确问题
    │
    ▼
LLM大模型总结
    │
    ▼
报告生成工具
    │
    ▼
生成分析报告
```

### 3.2 Agent扩展架构

系统设计支持多Agent协同工作：

```
┌─────────────────────────────────────────┐
│      Agent协同调度器                      │
│  - 任务分发                               │
│  - 结果聚合                               │
│  - 依赖管理                               │
└─────────────────────────────────────────┘
         │        │        │        │
         ▼        ▼        ▼        ▼
    ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
    │充电Agent│ │热管理Agent│ │能量Agent│ │行驶Agent│
    └────────┘ └────────┘ └────────┘ └────────┘
```

### 3.3 训练系统架构

```
训练管理界面
    │
    ▼
数据集管理
    ├─→ 普通数据集
    └─→ 思维链数据集
    │
    ▼
训练任务创建
    │
    ▼
Celery任务队列
    │
    ▼
训练执行
    ├─→ 进度跟踪
    ├─→ Loss曲线记录
    └─→ 模型检查点保存
    │
    ▼
模型版本管理
    ├─→ 版本发布
    ├─→ 版本选择
    └─→ 版本回滚
    │
    ▼
模型评估
    └─→ 评估指标展示
```

## 4. 数据流架构

### 4.1 充电分析数据流

```
BLF文件 → 报文解析 → DataFrame → 信号过滤 → 
流程模型推理 → RAG检索 → 问题分析 → LLM总结 → 报告生成
```

### 4.2 训练数据流

```
数据集上传 → 数据验证 → 数据预处理 → 训练任务创建 → 
训练执行 → 模型保存 → 版本注册 → 评估报告
```

### 4.3 日志数据流

```
应用日志 → 结构化日志 → 日志收集器 → 日志存储 → 
日志查询接口 → 前端展示
```

## 5. 安全架构

### 5.1 认证授权

- **JWT Token认证**: 用户登录后获取JWT token
- **角色权限控制**: 
  - 普通用户: 首页、对话、充电分析
  - 管理员: 所有页面访问权限
- **API权限验证**: 每个API端点进行权限检查

### 5.2 数据安全

- **文件上传验证**: 文件类型、大小限制
- **数据加密**: 敏感数据加密存储
- **API限流**: 防止API滥用

## 6. 部署架构

### 6.1 容器化部署

- **前端**: React Native应用打包为移动应用
- **后端**: Docker容器化部署
- **数据库**: PostgreSQL、Redis容器化
- **向量数据库**: ChromaDB容器化
- **对象存储**: MinIO容器化

### 6.2 服务编排

- **Docker Compose**: 本地开发环境
- **Kubernetes**: 生产环境（可选）

## 7. 监控与运维

### 7.1 监控指标

- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: API响应时间、错误率、QPS
- **业务指标**: 分析任务完成率、训练任务成功率

### 7.2 日志管理

- **集中式日志**: 所有服务日志统一收集
- **日志分级**: DEBUG、INFO、WARNING、ERROR
- **日志查询**: 支持时间范围、关键词搜索

## 8. 扩展性设计

### 8.1 Agent扩展

- **插件化Agent**: 新Agent可独立开发和部署
- **统一接口**: 所有Agent实现统一接口
- **动态注册**: Agent可动态注册到系统

### 8.2 模型扩展

- **模型适配器**: 支持多种LLM后端
- **模型热更新**: 支持模型版本热切换
- **A/B测试**: 支持多版本模型对比测试

## 9. 详细技术实现

### 9.1 充电分析Agent详细流程

#### 9.1.1 报文处理阶段
- **输入**: BLF文件（CAN总线日志文件）
- **处理**: 使用CanParse工具解析CAN报文
- **输出**: Pandas DataFrame，包含时间序列信号数据
- **关键信号**: 
  - BMS_DCChrgSt (充电状态)
  - BMS_BattCurrt (电池电流)
  - BMS_ChrgEndNum (充电结束次数)
  - CCS_OutputCurent (输出电流)
  - 等20+个关键信号

#### 9.1.2 流程控制模型阶段（1.5B）
- **模型类型**: 轻量级Transformer模型（1.5B参数）
- **输入**: DataFrame统计特征（均值、方差、最大值、最小值等）
- **输出**: 
  - 3个关键信号标识
  - 问题大方向分类（如：充电异常、通信故障、温度异常等）
- **推理方式**: 本地推理，低延迟

#### 9.1.3 RAG检索阶段
- **向量数据库**: ChromaDB
- **嵌入模型**: BGE-base-zh-v1.5（中文优化）
- **检索内容**:
  1. 相关专业知识文档（故障案例、技术手册等）
  2. 3个细化问题的关键信号建议
- **检索策略**: 混合检索（向量相似度 + 关键词匹配）

#### 9.1.4 迭代分析阶段（最多3次）
- **迭代1**: 使用RAG检索的知识和信号，分析实际信号表现
- **迭代2**: 如果问题未明确，进一步细化分析
- **迭代3**: 最后一次确认，明确问题
- **终止条件**: 问题明确 OR 达到最大迭代次数

#### 9.1.5 LLM总结阶段
- **模型**: OpenAI格式API（支持多种后端：OpenAI、本地部署等）
- **输入**: 
  - 原始数据摘要
  - 流程模型分析结果
  - RAG检索的知识
  - 迭代分析过程
- **输出**: 结构化问题总结

#### 9.1.6 报告生成阶段
- **格式**: Markdown/PDF
- **内容**:
  - 问题概述
  - 关键信号分析
  - 问题诊断结果
  - 建议措施
  - 相关技术文档引用

### 9.2 训练系统详细设计

#### 9.2.1 数据集类型
1. **普通数据集**
   - 格式: JSON/CSV
   - 结构: {input: 信号特征, output: 问题分类}
   - 用途: 分类任务训练

2. **思维链数据集**
   - 格式: JSON
   - 结构: {input: 信号特征, chain_of_thought: 推理过程, output: 问题分类}
   - 用途: 提升模型推理能力

#### 9.2.2 训练流程
1. **数据预处理**
   - 数据清洗
   - 特征工程
   - 数据增强

2. **训练执行**
   - 框架: PyTorch / Transformers
   - 训练方式: 分布式训练（可选）
   - 监控: 实时Loss、准确率等指标

3. **模型保存**
   - 检查点: 每个epoch保存
   - 最佳模型: 基于验证集性能
   - 版本管理: 自动版本号生成

4. **评估**
   - 测试集评估
   - 混淆矩阵
   - 分类报告

### 9.3 日志系统详细设计

#### 9.3.1 日志框架选择
- **主框架**: structlog（结构化日志）
- **存储**: PostgreSQL（元数据）+ TimescaleDB（时序数据）
- **查询**: 支持SQL查询和全文搜索

#### 9.3.2 日志分类
1. **系统日志**: 服务启动、停止、错误
2. **API日志**: 请求/响应、性能指标
3. **业务日志**: 分析任务、训练任务
4. **Agent日志**: Agent执行过程、决策记录

#### 9.3.3 日志结构
```json
{
  "timestamp": "2024-01-01T00:00:00Z",
  "level": "INFO",
  "service": "charging_agent",
  "user_id": "user123",
  "task_id": "task456",
  "message": "开始分析充电数据",
  "metadata": {
    "file_name": "charge_001.blf",
    "signals_count": 20
  }
}
```

### 9.4 Agent扩展机制

#### 9.4.1 Agent接口定义
```python
class BaseAgent:
    def analyze(self, data: Dict) -> Dict:
        """执行分析任务"""
        pass
    
    def get_capabilities(self) -> List[str]:
        """返回Agent能力列表"""
        pass
```

#### 9.4.2 Agent注册机制
- 配置文件注册
- 动态加载Agent类
- 统一生命周期管理

#### 9.4.3 Agent协同
- 任务分发: 根据任务类型路由到对应Agent
- 结果聚合: 多个Agent结果合并
- 依赖管理: Agent之间的依赖关系

